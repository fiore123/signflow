<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SignFlow Ultimate (Stable)</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        cursive: ['Great Vibes', 'cursive'],
                    },
                    colors: {
                        zinc: { 850: '#1f1f22', 950: '#09090b' },
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.2s ease-out',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #09090b;
            color: #f4f4f5;
            overflow: hidden;
            touch-action: none;
            -webkit-font-smoothing: antialiased;
        }

        /* Rendering Canvas */
        #the-canvas {
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6);
            border-radius: 4px; 
            max-width: 100%; height: auto !important;
        }

        /* Drag Items */
        .drag-item {
            position: absolute; cursor: grab; touch-action: none; user-select: none;
            border: 1px dashed transparent; transition: border-color 0.2s, background-color 0.2s;
        }
        .drag-item:hover, .drag-item.is-active {
            border-color: #6366f1; background-color: rgba(99, 102, 241, 0.1); z-index: 50;
        }
        .drag-item.is-dragging { cursor: grabbing; scale: 1.02; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .drag-item img { pointer-events: none; display: block; width: 100%; height: 100%; }

        /* Controls */
        .control-btn {
            position: absolute; width: 28px; height: 28px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: all 0.2s; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25); z-index: 60; transform: scale(0.8);
        }
        .drag-item:hover .control-btn, .drag-item.is-active .control-btn { opacity: 1; transform: scale(1); }
        
        .delete-btn { top: -14px; right: -14px; background: #ef4444; color: white; }
        .resize-handle { bottom: -12px; right: -12px; border: 2px solid #6366f1; cursor: nwse-resize; }
        .resize-handle::after { content: ''; width: 8px; height: 8px; background: #6366f1; border-radius: 50%; }

        /* Loader */
        .loader {
            width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.2);
            border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-[100dvh]">

    <!-- Navbar -->
    <header class="h-16 bg-zinc-900/80 backdrop-blur-xl border-b border-zinc-800 flex items-center justify-between px-4 sm:px-6 shrink-0 z-40">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600/20 p-2 rounded-lg">
                <i data-lucide="signature" class="text-indigo-400 h-5 w-5"></i>
            </div>
            <h1 class="font-bold text-lg hidden sm:block tracking-tight text-white">SignFlow <span class="text-indigo-400 font-normal">Ultimate</span></h1>
        </div>

        <div class="flex gap-2 sm:gap-3">
            <input type="file" id="file-upload" accept="application/pdf" class="hidden">
            
            <button onclick="document.getElementById('file-upload').click()" class="h-10 px-4 rounded-full bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 transition-all flex items-center gap-2 text-sm font-medium text-zinc-300 hover:text-white">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                <span class="hidden sm:inline">Abrir</span>
            </button>

            <!-- Action Group -->
            <div class="h-10 bg-zinc-800 rounded-full p-1 flex items-center border border-zinc-700">
                <button id="btn-add-sig" disabled onclick="openModal()" class="h-full px-4 rounded-full text-zinc-400 hover:text-white hover:bg-zinc-700 transition-all flex items-center gap-2 text-sm disabled:opacity-30">
                    <i data-lucide="pen-tool" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Assinar</span>
                </button>
                <div class="w-px h-4 bg-zinc-700 mx-1"></div>
                <button id="btn-add-date" disabled onclick="addDateStamp()" class="h-full px-4 rounded-full text-zinc-400 hover:text-white hover:bg-zinc-700 transition-all flex items-center gap-2 text-sm disabled:opacity-30">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Data</span>
                </button>
            </div>

            <button id="save-btn" disabled onclick="savePdf()" class="h-10 px-5 rounded-full bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20 transition-all flex items-center gap-2 text-sm font-medium disabled:opacity-50 disabled:shadow-none">
                <span class="hidden sm:inline">Finalizar</span>
                <i data-lucide="arrow-right" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- Workspace -->
    <main class="flex-1 relative overflow-hidden bg-zinc-950 flex flex-col">
        <div id="scroll-container" class="flex-1 overflow-auto flex justify-center p-4 sm:p-8 relative custom-scroll">
            
            <!-- Empty State -->
            <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-zinc-500">
                <div onclick="document.getElementById('file-upload').click()" class="cursor-pointer group relative">
                    <div class="absolute inset-0 bg-indigo-500 blur-[50px] opacity-10 group-hover:opacity-20 transition-opacity rounded-full"></div>
                    <div class="w-24 h-24 rounded-3xl bg-zinc-900 border border-zinc-800 flex items-center justify-center mb-6 shadow-2xl group-hover:scale-105 group-hover:border-indigo-500/50 transition-all duration-300">
                        <i data-lucide="file-up" class="w-10 h-10 text-zinc-500 group-hover:text-indigo-400 transition-colors"></i>
                    </div>
                </div>
                <h2 class="text-xl font-medium text-zinc-200">Arraste seu PDF aqui</h2>
                <p class="text-sm mt-2 text-zinc-600">Assinatura digital segura e local.</p>
            </div>

            <!-- PDF Layer -->
            <div id="pdf-wrapper" class="relative hidden shadow-2xl self-start mt-2 mb-24 bg-white transition-opacity duration-500 opacity-0">
                <canvas id="the-canvas" class="block"></canvas>
                <div id="layer-container" class="absolute inset-0 overflow-hidden"></div>
            </div>
        </div>

        <!-- Floating Pagination -->
        <div id="controls" class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 bg-zinc-900/90 backdrop-blur-md border border-zinc-700/50 rounded-full pl-2 pr-4 py-1.5 flex items-center gap-3 shadow-2xl z-40">
            <div class="flex gap-1">
                <button onclick="changePage(-1)" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-zinc-400 hover:text-white transition-colors"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                <button onclick="changePage(1)" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center text-zinc-400 hover:text-white transition-colors"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
            </div>
            <div class="h-4 w-px bg-zinc-700"></div>
            <span id="page-num" class="font-mono text-xs text-zinc-300 tabular-nums">1 / 1</span>
        </div>
    </main>

    <!-- Signature Modal -->
    <div id="modal" class="fixed inset-0 z-[100] hidden bg-black/60 backdrop-blur-sm flex items-end sm:items-center justify-center animate-fade-in p-0 sm:p-4">
        <div class="bg-zinc-900 border border-zinc-800 w-full max-w-md rounded-t-2xl sm:rounded-2xl shadow-2xl flex flex-col h-[90vh] sm:h-auto overflow-hidden animate-slide-up">
            
            <div class="flex justify-between items-center p-4 border-b border-zinc-800 bg-zinc-900/95">
                <h3 class="font-semibold text-white pl-2">Criar Assinatura</h3>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full hover:bg-zinc-800 flex items-center justify-center text-zinc-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="flex p-1.5 mx-4 mt-4 bg-zinc-950 rounded-xl border border-zinc-800">
                <button onclick="setTab('draw')" id="tab-draw" class="flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-zinc-800 text-white shadow-sm">Desenhar</button>
                <button onclick="setTab('type')" id="tab-type" class="flex-1 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white transition-all">Digitar</button>
            </div>

            <div class="px-6 py-4 flex items-center justify-center gap-6">
                <div class="flex items-center gap-2 cursor-pointer group" onclick="setInkColor('black')">
                    <div class="w-6 h-6 rounded-full bg-zinc-950 border-2 border-zinc-600 shadow-sm relative group-hover:scale-110 transition-transform">
                        <div class="absolute inset-0 rounded-full border-2 border-white opacity-0 transition-opacity" id="ring-black"></div>
                    </div>
                    <span class="text-xs text-zinc-400 group-hover:text-white transition-colors">Preto</span>
                </div>
                <div class="flex items-center gap-2 cursor-pointer group" onclick="setInkColor('blue')">
                    <div class="w-6 h-6 rounded-full bg-blue-700 border-2 border-blue-500 shadow-sm relative group-hover:scale-110 transition-transform">
                        <div class="absolute inset-0 rounded-full border-2 border-white opacity-0 transition-opacity" id="ring-blue"></div>
                    </div>
                    <span class="text-xs text-zinc-400 group-hover:text-white transition-colors">Azul</span>
                </div>
            </div>

            <div class="flex-1 px-4 pb-0 bg-zinc-900 flex flex-col relative">
                <div id="view-draw" class="flex-1 flex flex-col">
                    <div class="flex-1 border border-zinc-700 bg-[#18181b] rounded-xl relative overflow-hidden shadow-inner min-h-[180px]">
                        <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style="background-image: linear-gradient(#fff 1px, transparent 1px); background-size: 100% 32px;"></div>
                        <canvas id="pad" class="w-full h-full cursor-crosshair touch-none"></canvas>
                        <span class="absolute bottom-3 right-3 text-[10px] text-zinc-600 pointer-events-none font-medium uppercase tracking-wider">Assine Acima</span>
                    </div>
                    <div class="flex justify-between mt-3 px-1">
                        <button onclick="clearPad()" class="text-xs text-zinc-500 hover:text-white transition-colors flex items-center gap-1.5 py-2">
                            <i data-lucide="eraser" class="w-3.5 h-3.5"></i> Limpar
                        </button>
                        <button onclick="useLastSignature()" id="btn-restore" class="hidden text-xs text-indigo-400 hover:text-indigo-300 transition-colors flex items-center gap-1.5 py-2">
                            <i data-lucide="history" class="w-3.5 h-3.5"></i> Restaurar
                        </button>
                    </div>
                </div>

                <div id="view-type" class="hidden flex-1 flex flex-col items-center justify-center min-h-[180px] bg-zinc-950/50 rounded-xl border border-zinc-800">
                    <input type="text" id="type-input" placeholder="Digite seu nome" 
                        class="w-full bg-transparent text-center text-4xl text-white font-cursive focus:outline-none placeholder-zinc-700 px-4 py-2" 
                        oninput="updateTypePreview()">
                    <div class="w-1/2 h-px bg-zinc-800 mt-2"></div>
                    <p class="text-xs text-zinc-500 mt-4">Será gerado com estilo cursivo</p>
                </div>
            </div>

            <div class="p-4 pt-4 bg-zinc-900 border-t border-zinc-800 mt-2">
                <button onclick="addSignature()" class="w-full bg-indigo-600 hover:bg-indigo-500 active:scale-[0.98] text-white py-3.5 rounded-xl font-semibold shadow-lg shadow-indigo-500/20 transition-all flex items-center justify-center gap-2 text-sm">
                    <i data-lucide="check" class="w-4 h-4"></i> Confirmar Assinatura
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Init ---
        lucide.createIcons();
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let pdfBytes = null;
        let pageNum = 1;
        let items = [];
        let inkColor = 'black'; 
        let activeMode = 'draw'; 

        const COLORS = {
            black: { hex: '#000000', label: 'Preto' },
            blue: { hex: '#0033cc', label: 'Azul' }
        };

        const canvas = document.getElementById('the-canvas');
        const ctx = canvas.getContext('2d');
        const layer = document.getElementById('layer-container');
        const pad = document.getElementById('pad');
        const padCtx = pad.getContext('2d');

        document.getElementById('file-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (ev) => {
                pdfBytes = new Uint8Array(ev.target.result);
                try {
                    const loadingTask = pdfjsLib.getDocument(pdfBytes);
                    pdfDoc = await loadingTask.promise;
                    
                    document.getElementById('empty-state').classList.add('hidden');
                    const wrapper = document.getElementById('pdf-wrapper');
                    wrapper.classList.remove('hidden');
                    setTimeout(() => wrapper.classList.remove('opacity-0'), 50);
                    document.getElementById('controls').classList.remove('hidden');
                    
                    ['btn-add-sig', 'btn-add-date', 'save-btn'].forEach(id => {
                        document.getElementById(id).disabled = false;
                    });

                    pageNum = 1;
                    items = [];
                    renderPage(pageNum);
                } catch(err) {
                    alert("Erro ao abrir PDF.");
                }
            };
            reader.readAsArrayBuffer(file);
        });

        async function renderPage(num) {
            if (!pdfDoc) return;
            const page = await pdfDoc.getPage(num);
            
            const containerWidth = Math.min(window.innerWidth - 32, 1000);
            const unscaledViewport = page.getViewport({scale: 1});
            const cssScale = containerWidth / unscaledViewport.width;
            
            const viewport = page.getViewport({scale: cssScale});
            const outputScale = window.devicePixelRatio || 1;

            canvas.width = Math.floor(viewport.width * outputScale);
            canvas.height = Math.floor(viewport.height * outputScale);
            canvas.style.width = Math.floor(viewport.width) + "px";
            canvas.style.height = Math.floor(viewport.height) + "px";

            const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

            await page.render({
                canvasContext: ctx,
                transform: transform,
                viewport: viewport
            }).promise;
            
            document.getElementById('page-num').innerText = `${num} / ${pdfDoc.numPages}`;
            renderItems();
        }

        function changePage(delta) {
            if (!pdfDoc) return;
            const newPage = pageNum + delta;
            if (newPage >= 1 && newPage <= pdfDoc.numPages) {
                pageNum = newPage;
                renderPage(pageNum);
            }
        }

        function openModal() {
            document.getElementById('modal').classList.remove('hidden');
            resizePad();
            setTab('draw'); 
            setInkColor(inkColor);
            if(localStorage.getItem('signflow_last')) {
                document.getElementById('btn-restore').classList.remove('hidden');
            }
        }
        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function setTab(mode) {
            activeMode = mode;
            const tabDraw = document.getElementById('tab-draw');
            const tabType = document.getElementById('tab-type');
            const viewDraw = document.getElementById('view-draw');
            const viewType = document.getElementById('view-type');

            if (mode === 'draw') {
                tabDraw.className = "flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-zinc-800 text-white shadow-sm";
                tabType.className = "flex-1 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white transition-all";
                viewDraw.classList.remove('hidden');
                viewType.classList.add('hidden');
                setTimeout(resizePad, 10);
            } else {
                tabType.className = "flex-1 py-2 rounded-lg text-sm font-medium transition-all bg-zinc-800 text-white shadow-sm";
                tabDraw.className = "flex-1 py-2 rounded-lg text-sm font-medium text-zinc-400 hover:text-white transition-all";
                viewType.classList.remove('hidden');
                viewDraw.classList.add('hidden');
                document.getElementById('type-input').focus();
            }
            updateTypePreview();
        }

        function setInkColor(c) {
            inkColor = c;
            document.getElementById('ring-black').style.opacity = c === 'black' ? '1' : '0';
            document.getElementById('ring-blue').style.opacity = c === 'blue' ? '1' : '0';
            updateTypePreview();
        }

        function updateTypePreview() {
            const input = document.getElementById('type-input');
            input.style.color = (inkColor === 'blue') ? '#60a5fa' : '#ffffff'; 
        }

        let points = [];
        let isDrawing = false;

        function resizePad() {
            const rect = pad.parentElement.getBoundingClientRect();
            pad.width = rect.width;
            pad.height = rect.height;
            padCtx.lineJoin = 'round';
            padCtx.lineCap = 'round';
            padCtx.lineWidth = 3;
            padCtx.strokeStyle = '#fff';
        }

        function clearPad() {
            padCtx.clearRect(0, 0, pad.width, pad.height);
            points = [];
            document.getElementById('type-input').value = '';
        }

        function getPos(e) {
            const rect = pad.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        ['mousedown', 'touchstart'].forEach(ev => pad.addEventListener(ev, (e) => {
            isDrawing = true;
            points.push(getPos(e));
            e.preventDefault();
        }, {passive: false}));

        ['mousemove', 'touchmove'].forEach(ev => pad.addEventListener(ev, (e) => {
            if (!isDrawing) return;
            const pos = getPos(e);
            points.push(pos);
            if (points.length > 2) {
                const p1 = points[points.length - 3];
                const p2 = points[points.length - 2];
                const p3 = points[points.length - 1];
                const mid1 = { x: (p1.x + p2.x)/2, y: (p1.y + p2.y)/2 };
                const mid2 = { x: (p2.x + p3.x)/2, y: (p2.y + p3.y)/2 };

                padCtx.beginPath();
                padCtx.moveTo(mid1.x, mid1.y);
                padCtx.quadraticCurveTo(p2.x, p2.y, mid2.x, mid2.y);
                padCtx.stroke();
            }
            e.preventDefault();
        }, {passive: false}));

        ['mouseup', 'touchend'].forEach(ev => pad.addEventListener(ev, () => {
            isDrawing = false;
            points = [];
        }));

        function addSignature() {
            let dataUrl;

            if (activeMode === 'draw') {
                const tCanvas = document.createElement('canvas');
                tCanvas.width = pad.width;
                tCanvas.height = pad.height;
                const tCtx = tCanvas.getContext('2d');
                
                tCtx.drawImage(pad, 0, 0);
                tCtx.globalCompositeOperation = 'source-in';
                tCtx.fillStyle = COLORS[inkColor].hex;
                tCtx.fillRect(0, 0, tCanvas.width, tCanvas.height);
                dataUrl = tCanvas.toDataURL();
                
                localStorage.setItem('signflow_last', dataUrl);

            } else {
                const text = document.getElementById('type-input').value.trim();
                if (!text) return alert("Digite seu nome.");

                const tCanvas = document.createElement('canvas');
                tCanvas.width = 1000;
                tCanvas.height = 300;
                const tCtx = tCanvas.getContext('2d');

                tCtx.font = "italic 120px 'Great Vibes'";
                tCtx.fillStyle = COLORS[inkColor].hex;
                tCtx.textAlign = "center";
                tCtx.textBaseline = "middle";
                tCtx.fillText(text, 500, 150);
                
                dataUrl = tCanvas.toDataURL();
            }

            placeItem({ type: 'img', data: dataUrl, w: 150 });
            closeModal();
            clearPad();
        }

        function useLastSignature() {
            const saved = localStorage.getItem('signflow_last');
            if(saved) {
                placeItem({ type: 'img', data: saved, w: 150 });
                closeModal();
            }
        }

        function addDateStamp() {
            const d = new Date().toLocaleDateString('pt-BR');
            // FIX: Convert Data to Image to avoid Font Embedding Errors
            const tCanvas = document.createElement('canvas');
            tCanvas.width = 400;
            tCanvas.height = 100;
            const tCtx = tCanvas.getContext('2d');
            
            tCtx.font = "500 60px 'Inter'"; // Matches UI
            tCtx.fillStyle = "#000000";
            tCtx.textAlign = "center";
            tCtx.textBaseline = "middle";
            tCtx.fillText(d, 200, 50);

            placeItem({ type: 'img', data: tCanvas.toDataURL(), w: 120 });
        }

        function placeItem(obj) {
            items.push({
                id: Date.now(),
                type: 'img', // Force all to img
                page: pageNum,
                x: 40, y: 45,
                w: obj.w,
                data: obj.data
            });
            renderItems();
        }

        function renderItems() {
            layer.innerHTML = '';
            items.forEach(item => {
                if(item.page !== pageNum) return;

                const el = document.createElement('div');
                el.className = 'drag-item group';
                el.style.left = item.x + '%';
                el.style.top = item.y + '%';
                el.style.width = item.w + 'px';

                el.innerHTML = `<img src="${item.data}">`;

                el.innerHTML += `
                    <div class="control-btn delete-btn" id="del-${item.id}"><i data-lucide="x" class="w-4 h-4"></i></div>
                    <div class="control-btn resize-handle" id="res-${item.id}"></div>
                `;

                el.querySelector(`#del-${item.id}`).addEventListener('pointerdown', (e) => {
                    e.stopPropagation();
                    items = items.filter(i => i.id !== item.id);
                    renderItems();
                });

                layer.appendChild(el);
                initDrag(el, item);
            });
            lucide.createIcons();
        }

        function initDrag(el, item) {
            let state = null;
            let start = {x:0, y:0};
            let initial = {l:0, t:0, w:0};
            const p = layer.getBoundingClientRect();

            const onDown = (e) => {
                if(e.target.classList.contains('resize-handle')) state = 'resize';
                else if(e.target.closest('.delete-btn')) return;
                else state = 'drag';
                
                el.classList.add('is-active', state === 'drag' ? 'is-dragging' : 'no-op');
                el.setPointerCapture(e.pointerId);
                start = {x: e.clientX, y: e.clientY};
                initial = {l: el.offsetLeft, t: el.offsetTop, w: el.offsetWidth};
                e.preventDefault();
            };

            const onMove = (e) => {
                if(!state) return;
                const dx = e.clientX - start.x;
                const dy = e.clientY - start.y;

                if(state === 'drag') {
                    let nl = initial.l + dx;
                    let nt = initial.t + dy;
                    nl = Math.max(0, Math.min(nl, p.width - el.offsetWidth));
                    nt = Math.max(0, Math.min(nt, p.height - el.offsetHeight));
                    el.style.left = nl + 'px';
                    el.style.top = nt + 'px';
                } else {
                    let nw = Math.max(40, Math.min(initial.w + dx, p.width - initial.l));
                    el.style.width = nw + 'px';
                }
            };

            const onUp = (e) => {
                if(!state) return;
                el.classList.remove('is-active', 'is-dragging');
                el.releasePointerCapture(e.pointerId);
                
                if(state === 'drag') {
                    item.x = (el.offsetLeft / p.width) * 100;
                    item.y = (el.offsetTop / p.height) * 100;
                } else {
                    item.w = el.offsetWidth;
                }
                state = null;
            };

            el.addEventListener('pointerdown', onDown);
            el.addEventListener('pointermove', onMove);
            el.addEventListener('pointerup', onUp);
        }

        async function savePdf() {
            if (items.length === 0) return alert("Documento sem alterações.");
            
            const btn = document.getElementById('save-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>';

            try {
                const pdfDocLib = await PDFLib.PDFDocument.load(pdfBytes);
                // No font embedding needed anymore!
                const pages = pdfDocLib.getPages();

                for(const item of items) {
                    const page = pages[item.page - 1];
                    const { width, height } = page.getSize();
                    const scaleFactor = width / canvas.getBoundingClientRect().width;
                    
                    const pdfW = item.w * scaleFactor;
                    const pdfX = (item.x / 100) * width;
                    
                    // Everything is IMG now
                    const img = await pdfDocLib.embedPng(item.data);
                    const pdfH = (img.height/img.width) * pdfW;
                    const pdfY = height - ((item.y/100)*height) - pdfH;
                    page.drawImage(img, { x: pdfX, y: pdfY, width: pdfW, height: pdfH });
                }

                const pdfData = await pdfDocLib.save();
                download(pdfData, `Documento_Assinado_${Date.now()}.pdf`, "application/pdf");
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#6366f1', '#ffffff'] });

            } catch(e) {
                alert("Erro ao salvar: " + e.message);
                console.error(e);
            } finally {
                btn.innerHTML = originalHTML;
            }
        }
    </script>
</body>
</html>

